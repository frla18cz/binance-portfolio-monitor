
{% extends "admin/base.html" %}

{% block title %}Fee Management - Config Admin{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #2c3e50; margin-bottom: 30px;">
        Fee Management
        <a href="{{ url_for('accounts') }}" style="float: right; font-size: 16px; color: #3498db; text-decoration: none;">
            ‚Üê Back to Accounts
        </a>
    </h1>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #3498db;">Process Overview</h3>
        <p>This page lists all performance fees that have been calculated (ACCRUED) but not yet collected.</p>
        <ol>
            <li>Find the fee you want to process in the table below.</li>
            <li>Identify the corresponding withdrawal transaction from the dropdown list.</li>
            <li>Click "Mark as Collected" to link the fee to the transaction.</li>
        </ol>
        <p>This will update the fee status to COLLECTED and re-classify the transaction as a FEE_WITHDRAWAL for accurate TWR calculations.</p>
    </div>

    {% if accrued_fees %}
    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <thead>
            <tr style="background: #3498db; color: white;">
                <th style="padding: 15px; text-align: left;">Account</th>
                <th style="padding: 15px; text-align: left;">Period</th>
                <th style="padding: 15px; text-align: right;">Fee Amount</th>
                <th style="padding: 15px; text-align: left;">Select Withdrawal Transaction</th>
                <th style="padding: 15px; text-align: center;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for fee in accrued_fees %}
            <tr style="border-bottom: 1px solid #ecf0f1;">
                <td style="padding: 15px;"><strong>{{ fee.account_name }}</strong></td>
                <td style="padding: 15px;">{{ fee.period_start|date }} to {{ fee.period_end|date }}</td>
                <td style="padding: 15px; text-align: right;">{{ "%.8f"|format(fee.performance_fee) }}</td>
                <td style="padding: 15px;">
                    <form method="POST" action="{{ url_for('collect_fee') }}" id="form-{{ fee.id }}">
                        <input type="hidden" name="fee_id" value="{{ fee.id }}">
                        <select name="transaction_id" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                            <option value="">-- Select a withdrawal --</option>
                            {% for tx in fee.potential_transactions %}
                            <option value="{{ tx.transaction_id }}">
                                {{ tx.timestamp|date }} - {{ "%.8f"|format(tx.amount) }} {{ tx.metadata.coin }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </td>
                <td style="padding: 15px; text-align: center;">
                    <button type="submit" form="form-{{ fee.id }}" style="background: #2ecc71; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                        Mark as Collected
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="background: #f8f9fa; padding: 40px; text-align: center; border-radius: 8px;">
        <p style="color: #7f8c8d; margin: 0;">No accrued fees to process. Good job!</p>
    </div>
    {% endif %}
</div>
{% endblock %}

