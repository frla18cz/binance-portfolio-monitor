{% extends "admin/base.html" %}

{% block title %}Edit Configuration{% endblock %}

{% block content %}
<style>
    .warning-banner {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .warning-banner strong {
        display: block;
        margin-bottom: 5px;
    }
    .edit-form {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        max-width: 800px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
    }
    .form-group input, 
    .form-group textarea, 
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    .form-group textarea {
        min-height: 150px;
        font-family: 'Courier New', monospace;
    }
    .form-group input:focus, 
    .form-group textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    .help-text {
        font-size: 13px;
        color: #6c757d;
        margin-top: 5px;
    }
    .current-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .current-info code {
        background-color: #e9ecef;
        padding: 2px 5px;
        border-radius: 3px;
    }
    .btn-group {
        margin-top: 20px;
    }
    .btn-primary {
        background-color: #28a745;
        margin-right: 10px;
    }
    .btn-primary:hover {
        background-color: #218838;
    }
    .btn-secondary {
        background-color: #6c757d;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
    }
    .validation-error {
        color: #dc3545;
        font-size: 13px;
        margin-top: 5px;
        display: none;
    }
    .radio-group {
        display: flex;
        gap: 20px;
    }
    .radio-group label {
        font-weight: normal;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .radio-group input {
        width: auto;
        margin-right: 5px;
    }
</style>

<h2>Edit Configuration</h2>

{% if config.key in ['financial.performance_alert_thresholds', 'scheduling.daemon_interval_seconds', 'financial.rebalance_frequency'] %}
<div class="warning-banner">
    <strong>⚠️ Warning: This configuration is not currently used</strong>
    {% if config.key == 'financial.performance_alert_thresholds' %}
        This configuration is defined but not implemented. Alert functionality has not been built yet.
    {% elif config.key == 'scheduling.daemon_interval_seconds' %}
        This configuration is deprecated. Use <code>scheduling.cron_interval_minutes</code> instead.
    {% elif config.key == 'financial.rebalance_frequency' %}
        This configuration is not used. Rebalancing is controlled by the <code>rebalance_day</code> and <code>rebalance_hour</code> fields in the benchmark_configs table.
    {% endif %}
</div>
{% endif %}

<div class="current-info">
    <strong>Key:</strong> <code>{{ config.key }}</code><br>
    <strong>Category:</strong> {{ config.category }}<br>
    {% if config.source == 'static' %}
        <strong>Source:</strong> Static configuration (will create database override)
    {% else %}
        <strong>Version:</strong> {{ config.version or 1 }}
    {% endif %}
    <br><br>
    <strong>Cache TTL:</strong> Changes take up to 5 minutes to apply, or use "Refresh Cache" button
</div>

<form class="edit-form" action="{{ url_for('save_config', key=config.key) }}" method="POST" onsubmit="return validateForm()">
    <input type="hidden" name="value_type" value="{{ value_type }}">
    
    <div class="form-group">
        <label for="value">Value</label>
        
        {% if value_type == 'boolean' %}
            <div class="radio-group">
                <label>
                    <input type="radio" name="value" value="true" {% if config.current_value %}checked{% endif %}>
                    True
                </label>
                <label>
                    <input type="radio" name="value" value="false" {% if not config.current_value %}checked{% endif %}>
                    False
                </label>
            </div>
        {% elif value_type == 'json' %}
            {% if config.key == 'logging.database_logging.log_levels' %}
                <div style="margin-bottom: 10px;">
                    <label><input type="checkbox" class="log-level" value="DEBUG"> DEBUG</label><br>
                    <label><input type="checkbox" class="log-level" value="INFO" checked> INFO</label><br>
                    <label><input type="checkbox" class="log-level" value="WARNING" checked> WARNING</label><br>
                    <label><input type="checkbox" class="log-level" value="ERROR" checked> ERROR</label><br>
                    <label><input type="checkbox" class="log-level" value="CRITICAL" checked> CRITICAL</label>
                </div>
                <textarea name="value" id="value" style="display:none;" required>{{ value_json }}</textarea>
                <div class="help-text">Select which log levels to store in the database</div>
                <script>
                    // Initialize checkboxes based on current value
                    const currentLevels = {{ value_json|safe }};
                    document.querySelectorAll('.log-level').forEach(cb => {
                        cb.checked = currentLevels.includes(cb.value);
                    });
                    
                    // Update hidden textarea when checkboxes change
                    document.querySelectorAll('.log-level').forEach(cb => {
                        cb.addEventListener('change', () => {
                            const selected = Array.from(document.querySelectorAll('.log-level:checked'))
                                .map(cb => cb.value);
                            document.getElementById('value').value = JSON.stringify(selected, null, 2);
                        });
                    });
                    
                    // Initialize the textarea
                    const initialSelected = Array.from(document.querySelectorAll('.log-level:checked'))
                        .map(cb => cb.value);
                    document.getElementById('value').value = JSON.stringify(initialSelected, null, 2);
                </script>
            {% else %}
                <textarea name="value" id="value" required>{{ value_json }}</textarea>
                <div class="help-text">Enter valid JSON. Objects and arrays are supported.</div>
            {% endif %}
        {% elif value_type == 'number' %}
            {% if config.key == 'fee_management.calculation_schedule' %}
                <select name="value" id="value" required>
                    <option value="monthly" {% if config.current_value == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="daily" {% if config.current_value == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="hourly" {% if config.current_value == 'hourly' %}selected{% endif %}>Hourly</option>
                </select>
                <div class="help-text">How often to calculate performance fees</div>
            {% elif config.key == 'fee_management.calculation_day' %}
                <select name="value" id="value" required>
                    {% for day in range(1, 29) %}
                        <option value="{{ day }}" {% if config.current_value == day %}selected{% endif %}>{{ day }}</option>
                    {% endfor %}
                </select>
                <div class="help-text">Day of month for monthly fee calculations (1-28)</div>
            {% elif config.key == 'fee_management.calculation_hour' %}
                <select name="value" id="value" required>
                    {% for hour in range(24) %}
                        <option value="{{ hour }}" {% if config.current_value == hour %}selected{% endif %}>{{ hour }}:00 UTC</option>
                    {% endfor %}
                </select>
                <div class="help-text">Hour of day for fee calculations (UTC timezone)</div>
            {% elif config.key == 'scheduling.cron_interval_minutes' %}
                <select name="value" id="value" required>
                    <option value="5" {% if config.current_value == 5 %}selected{% endif %}>5 minutes</option>
                    <option value="10" {% if config.current_value == 10 %}selected{% endif %}>10 minutes</option>
                    <option value="15" {% if config.current_value == 15 %}selected{% endif %}>15 minutes</option>
                    <option value="30" {% if config.current_value == 30 %}selected{% endif %}>30 minutes</option>
                    <option value="60" {% if config.current_value == 60 %}selected{% endif %}>60 minutes (1 hour)</option>
                </select>
                <div class="help-text">How often to run portfolio monitoring. Note: Requires restart of run_forever.py</div>
            {% elif config.key.endswith('_rate') or config.key.endswith('percentage') %}
                <input type="number" name="value" id="value" value="{{ config.current_value }}" step="0.01" min="0" max="1" required>
                <div class="help-text">Enter a decimal between 0.0 and 1.0 (e.g., 0.5 for 50%)</div>
            {% elif 'threshold' in config.key %}
                <input type="number" name="value" id="value" value="{{ config.current_value }}" step="0.001" min="0" required>
                <div class="help-text">Minimum value in USD to include in calculations</div>
            {% else %}
                <input type="number" name="value" id="value" value="{{ config.current_value }}" step="any" required>
            {% endif %}
        {% else %}
            {% if config.key == 'fee_management.calculation_schedule' %}
                <select name="value" id="value" required>
                    <option value="monthly" {% if config.current_value == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="daily" {% if config.current_value == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="hourly" {% if config.current_value == 'hourly' %}selected{% endif %}>Hourly</option>
                </select>
                <div class="help-text">How often to calculate performance fees</div>
            {% else %}
                <input type="text" name="value" id="value" value="{{ config.current_value }}" required>
            {% endif %}
        {% endif %}
        
        <div class="validation-error" id="validation-error"></div>
    </div>
    
    <div class="form-group">
        <label for="description">Change Description (optional)</label>
        <input type="text" name="description" id="description" placeholder="Reason for this change">
        <div class="help-text">This will be recorded in the change history.</div>
    </div>
    
    <div class="btn-group">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
function validateForm() {
    const valueInput = document.getElementById('value');
    const errorDiv = document.getElementById('validation-error');
    const valueType = '{{ value_type }}';
    const key = '{{ config.key }}';
    
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
    
    // Type validation
    if (valueType === 'json') {
        try {
            JSON.parse(valueInput.value);
        } catch (e) {
            errorDiv.textContent = 'Invalid JSON format: ' + e.message;
            errorDiv.style.display = 'block';
            return false;
        }
    }
    
    // Key-specific validation
    const value = valueInput.value;
    
    if (key.includes('_rate') || key.includes('percentage')) {
        const numVal = parseFloat(value);
        if (numVal < 0 || numVal > 1) {
            errorDiv.textContent = 'Rate must be between 0 and 1';
            errorDiv.style.display = 'block';
            return false;
        }
    }
    
    if (key === 'fee_management.calculation_schedule') {
        if (!['monthly', 'daily', 'hourly'].includes(value)) {
            errorDiv.textContent = 'Schedule must be monthly, daily, or hourly';
            errorDiv.style.display = 'block';
            return false;
        }
    }
    
    if (key.includes('_minutes') || key.includes('_seconds') || key.includes('_hours')) {
        const numVal = parseFloat(value);
        if (numVal < 0) {
            errorDiv.textContent = 'Time value must be positive';
            errorDiv.style.display = 'block';
            return false;
        }
    }
    
    return true;
}

// Real-time JSON validation
{% if value_type == 'json' %}
document.getElementById('value').addEventListener('input', function() {
    const errorDiv = document.getElementById('validation-error');
    try {
        JSON.parse(this.value);
        errorDiv.style.display = 'none';
    } catch (e) {
        errorDiv.textContent = 'Invalid JSON: ' + e.message;
        errorDiv.style.display = 'block';
    }
});
{% endif %}
</script>
{% endblock %}